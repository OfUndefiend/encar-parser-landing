<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ENcar — список авто</title>
  <meta name="description" content="Список автомобилей с ENCAR: фото, цена, год, пробег." />
  <style>
    :root{
      --gap:16px; --radius:16px; --shadow:0 6px 20px rgba(0,0,0,.08);
      --bg:#fafafa; --fg:#111; --muted:#666; --card:#fff; --line:#eee;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:20}
    header .bar{max-width:1200px;margin:0 auto;display:grid;gap:10px;padding:12px 16px;
      grid-template-columns:1fr;align-items:center}
    @media (min-width:900px){header .bar{grid-template-columns:1fr auto auto auto}}
    .brand{font-weight:800}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    input[type="search"],select{padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:#fff}
    .container{max-width:1200px;margin:0 auto;padding:20px 16px}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:var(--gap)}
    @media (min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .thumb{position:relative;aspect-ratio:4/3;background:#ddd}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .body{padding:14px 14px 16px}
    .title{font-weight:800;margin:0 0 8px;font-size:16px;line-height:1.32}
    .meta{color:var(--muted);margin:0 0 10px;font-size:14px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .price{font-weight:900}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#111;color:#fff;cursor:pointer;text-decoration:none;font-weight:700;box-shadow:0 4px 14px rgba(0,0,0,.14)}
    .btn:active{transform:translateY(1px)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .chip{background:#f1f1f1;border:1px solid #e5e5e5;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
    .chip.active{background:#111;color:#fff;border-color:#111}
    .status{color:var(--muted);font-size:13px;margin:8px 0 0}
    .pager{display:flex;gap:8px;justify-content:center;align-items:center;margin:18px 0 6px}
    .pgbtn{padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
    .pgbtn[disabled]{opacity:.5;cursor:not-allowed}
    .skeleton{background:#eee;animation:pulse 1.1s infinite ease-in-out}
    @keyframes pulse{0%{opacity:1}50%{opacity:.6}100%{opacity:1}}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">ENcar — тестовый листинг</div>
      <div class="controls">
        <input id="q" type="search" placeholder="Поиск: марка, модель…" />
        <select id="sort">
          <option value="price-asc">Цена ↑</option>
          <option value="price-desc" selected>Цена ↓</option>
          <option value="year-desc">Год ↓</option>
          <option value="year-asc">Год ↑</option>
          <option value="km-asc">Пробег ↑</option>
          <option value="km-desc">Пробег ↓</option>
        </select>
        <select id="perpage">
          <option>12</option>
          <option selected>18</option>
          <option>30</option>
          <option>60</option>
        </select>
      </div>
      <div id="updated" class="status"></div>
    </div>
  </header>

  <div class="container">
    <div id="chips" class="chips"></div>
    <div id="grid" class="grid" aria-live="polite"></div>
    <div class="pager">
      <button id="prev" class="pgbtn">Назад</button>
      <span id="pageinfo" class="status"></span>
      <button id="next" class="pgbtn">Вперёд</button>
    </div>
    <p id="ft" class="status"></p>
  </div>

<script>
(function(){
  const grid = document.getElementById('grid');
  const chips = document.getElementById('chips');
  const q = document.getElementById('q');
  const sortSel = document.getElementById('sort');
  const perSel = document.getElementById('perpage');
  const updated = document.getElementById('updated');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const pageInfo = document.getElementById('pageinfo');
  const ft = document.getElementById('ft');

  let ALL = [];
  let brandFilter = '';
  let page = 1;

  
  function showSkeleton(n=9){
    grid.innerHTML = Array.from({length:n}).map(()=>`
      <article class="card">
        <div class="thumb skeleton"></div>
        <div class="body">
          <div class="skeleton" style="height:18px;width:60%;border-radius:6px;margin:6px 0;"></div>
          <div class="skeleton" style="height:14px;width:40%;border-radius:6px;margin:6px 0 12px;"></div>
          <div class="skeleton" style="height:36px;width:100px;border-radius:10px;"></div>
        </div>
      </article>
    `).join('');
  }

  function formatKRW(v){
    if (v == null) return '—';
    try { return new Intl.NumberFormat('ko-KR', {style:'currency', currency:'KRW', maximumFractionDigits:0}).format(v); }
    catch(e){ return (v.toLocaleString('ru-RU')) + ' ₩'; }
  }
  function km(v){
    if (v == null) return '';
    return new Intl.NumberFormat('ru-RU').format(v) + ' км';
  }

  function uniqueBrands(cars){
    return [...new Set(cars.map(c => c.brand).filter(Boolean))].slice(0, 18);
  }

  function applyFilters(){
    const term = (q.value || '').toLowerCase().trim();
    let list = [...ALL];
    if (brandFilter) list = list.filter(c => (c.brand||'') === brandFilter);
    if (term) list = list.filter(c => (`${c.brand||''} ${c.model||''} ${c.year||''}`).toLowerCase().includes(term));

    
    const [key, dir] = (sortSel.value||'price-desc').split('-');
    const mul = dir === 'asc' ? 1 : -1;
    list.sort((a,b)=>{
      const va = key==='price'? (a.price_krw ?? -1) : key==='year'? (a.year ?? -1) : (a.mileage_km ?? 1e12);
      const vb = key==='price'? (b.price_krw ?? -1) : key==='year'? (b.year ?? -1) : (b.mileage_km ?? 1e12);
      return (va - vb) * mul;
    });

    return list;
  }

  function render(){
    const per = parseInt(perSel.value,10)||18;
    const list = applyFilters();

    const pages = Math.max(1, Math.ceil(list.length / per));
    if (page > pages) page = pages;
    const start = (page-1)*per, end = start + per;
    const slice = list.slice(start, end);

    grid.innerHTML = slice.map(c => `
      <article class="card">
        <div class="thumb">
          <img src="${c.image || ''}" alt="${(c.brand||'') + ' ' + (c.model||'')}"
               loading="lazy" onerror="this.src='https://via.placeholder.com/600x450?text=No+Image'"/>
        </div>
        <div class="body">
          <h3 class="title">${[c.brand, c.model].filter(Boolean).join(' ') || 'Автомобиль'}</h3>
          <p class="meta">
            ${c.year ? (c.year + ' г.') : ''}${c.mileage_km ? (' • ' + km(c.mileage_km)) : ''}
          </p>
          <div class="row">
            <div class="price">${formatKRW(c.price_krw)}</div>
            <a class="btn" href="${c.link || '#'}" target="_blank" rel="noopener">Подробнее</a>
          </div>
        </div>
      </article>
    `).join('') || '<p class="status">Ничего не найдено.</p>';

    pageInfo.textContent = `${page} / ${pages}`;
    prevBtn.disabled = page<=1;
    nextBtn.disabled = page>=pages;
  }

  async function init(){
    showSkeleton();
    try{
      const res = await fetch('./data/cars.json', {cache:'no-store'});
      const json = await res.json();
      ALL = json.cars || [];
    
      const brands = uniqueBrands(ALL);
      chips.innerHTML = ['Все', ...brands].map(b => {
        const val = b==='Все'?'':b;
        const cls = val===brandFilter?'chip active':'chip';
        return `<button class="${cls}" data-b="${val}">${b}</button>`;
      }).join('');
      chips.onclick = (e)=>{
        const b = e.target.getAttribute('data-b');
        if (b===null) return;
        brandFilter = b;
        [...chips.querySelectorAll('.chip')].forEach(el=>el.classList.remove('active'));
        e.target.classList.add('active');
        page = 1;
        render();
      };

      
      if (json.updated_at){
        const d = new Date(json.updated_at*1000);
        updated.textContent = 'Обновлено: ' + d.toLocaleString();
      }

      render();
      ft.textContent = `Всего записей: ${ALL.length}`;
    }catch(err){
      grid.innerHTML = `<p class="status">Не удалось загрузить data/cars.json</p>`;
      console.error(err);
    }
  }

  q.addEventListener('input', ()=>{ page=1; render(); });
  sortSel.addEventListener('change', ()=>{ page=1; render(); });
  perSel.addEventListener('change', ()=>{ page=1; render(); });
  prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; render(); }});
  nextBtn.addEventListener('click', ()=>{ page++; render(); });

  init();
})();
</script>
</body>
</html>
